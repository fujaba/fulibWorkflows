- c: 	org.fulib.classmodel.ClassModel
  classes: 	shopModel 	shopService 	order 	customer
  defaultCollectionType: 	c1
  defaultPropertyStyle: 	Bean
  defaultRoleType: 	"java.util.ArrayList<%s>"
  mainJavaDir: 	"test/src/main/java"
  packageName: 	uks.debuggen.shop.Shop
  packageSrcFolder: 	"test/src/main/java/uks/debuggen/shop/Shop"

- shopModel: 	org.fulib.classmodel.Clazz
  attributes: 	shopModel_modelMap
  importList: 	"import java.util.LinkedHashMap;"
  imports: 	"import java.util.LinkedHashMap;"
  methods: 	shopModel_getOrCreateOrder 	shopModel_getOrCreateCustomer
  model: 	c
  modified: 	false
  name: 	ShopModel
  propertyStyle: 	Bean

- shopService: 	org.fulib.classmodel.Clazz
  attributes: 	shopService_history 	shopService_port 	shopService_spark 	shopService_model 	shopService_handlerMap
  importList: 	"import java.util.LinkedHashMap;" 	"import java.util.Map;" 	"import java.util.function.Consumer;" 	"import uks.debuggen.shop.events.*;" 	"import org.fulib.yaml.Yaml;" 	"import spark.Service;" 	"import spark.Request;" 	"import spark.Response;" 	"import com.mashape.unirest.http.HttpResponse;" 	"import com.mashape.unirest.http.Unirest;" 	"import com.mashape.unirest.http.exceptions.UnirestException;" 	"import java.util.concurrent.ExecutorService;" 	"import java.util.concurrent.Executors;" 	"import java.util.logging.Logger;" 	"import java.util.logging.Level;"
  imports: 	"import java.util.LinkedHashMap;" 	"import java.util.Map;" 	"import java.util.function.Consumer;" 	"import uks.debuggen.shop.events.*;" 	"import org.fulib.yaml.Yaml;" 	"import spark.Service;" 	"import spark.Request;" 	"import spark.Response;" 	"import com.mashape.unirest.http.HttpResponse;" 	"import com.mashape.unirest.http.Unirest;" 	"import com.mashape.unirest.http.exceptions.UnirestException;" 	"import java.util.concurrent.ExecutorService;" 	"import java.util.concurrent.Executors;" 	"import java.util.logging.Logger;" 	"import java.util.logging.Level;"
  methods: 	shopService_start 	shopService_getHello 	shopService_subscribeAndLoadOldEvents 	shopService_apply 	shopService_handleOrderRegistered 	shopService_handleOrderApproved 	shopService_handleOrderPicked 	shopService_handleOrderDeclined 	shopService_initEventHandlerMap 	shopService_ignoreEvent 	shopService_publish 	shopService_postApply
  model: 	c
  modified: 	false
  name: 	ShopService
  propertyStyle: 	Bean

- order: 	org.fulib.classmodel.Clazz
  attributes: 	order_id 	order_product 	order_customer 	order_address 	order_state
  model: 	c
  modified: 	false
  name: 	Order
  propertyStyle: 	Bean

- customer: 	org.fulib.classmodel.Clazz
  attributes: 	customer_id 	customer_orders
  model: 	c
  modified: 	false
  name: 	Customer
  propertyStyle: 	Bean

- c1: 	org.fulib.classmodel.CollectionType
  implClass: 	class java.util.ArrayList
  implTemplate: 	"java.util.ArrayList<%s>"
  itf: 	org.fulib.classmodel.CollectionInterface.List
  qualifiedImplName: 	java.util.ArrayList
  simpleImplName: 	ArrayList

- shopModel_modelMap: 	org.fulib.classmodel.Attribute
  clazz: 	shopModel
  id: 	ShopModel_modelMap
  initialization: 	"new LinkedHashMap<>()"
  modified: 	false
  name: 	modelMap
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<String, Object>"
  typeSignature: 	"LinkedHashMap<String,Object>"

- shopModel_getOrCreateOrder: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopModel
  declaration: 	"public Order getOrCreateOrder(String id)"
  id: 	ShopModel_getOrCreateOrder
  methodBody: 	"return (Order) modelMap.computeIfAbsent(id, k -> new Order().setId(k));
"
  modified: 	false
  modifiers: 	public
  name: 	getOrCreateOrder
  paramsString: 	"String id"
  returnType: 	Order
  signature: 	"class/ShopModel/method/getOrCreateOrder(String)"

- shopModel_getOrCreateCustomer: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopModel
  declaration: 	"public Customer getOrCreateCustomer(String id)"
  id: 	ShopModel_getOrCreateCustomer
  methodBody: 	"return (Customer) modelMap.computeIfAbsent(id, k -> new Customer().setId(k));
"
  modified: 	false
  modifiers: 	public
  name: 	getOrCreateCustomer
  paramsString: 	"String id"
  returnType: 	Customer
  signature: 	"class/ShopModel/method/getOrCreateCustomer(String)"

- shopService_history: 	org.fulib.classmodel.Attribute
  clazz: 	shopService
  id: 	ShopService_history
  initialization: 	"new LinkedHashMap<>()"
  modified: 	false
  name: 	history
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<String, Event>"
  typeSignature: 	"LinkedHashMap<String,Event>"

- shopService_port: 	org.fulib.classmodel.Attribute
  clazz: 	shopService
  id: 	ShopService_port
  initialization: 	42100
  modified: 	false
  name: 	port
  propertyStyle: 	Bean
  type: 	int
  typeSignature: 	int

- shopService_spark: 	org.fulib.classmodel.Attribute
  clazz: 	shopService
  id: 	ShopService_spark
  modified: 	false
  name: 	spark
  propertyStyle: 	Bean
  type: 	Service
  typeSignature: 	Service

- shopService_model: 	org.fulib.classmodel.Attribute
  clazz: 	shopService
  id: 	ShopService_model
  modified: 	false
  name: 	model
  propertyStyle: 	Bean
  type: 	ShopModel
  typeSignature: 	ShopModel

- shopService_handlerMap: 	org.fulib.classmodel.Attribute
  clazz: 	shopService
  id: 	ShopService_handlerMap
  modified: 	false
  name: 	handlerMap
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<Class, Consumer<Event>>"
  typeSignature: 	"LinkedHashMap<Class,Consumer<Event>>"

- shopService_start: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"public void start()"
  id: 	ShopService_start
  methodBody: 	"model = new ShopModel();
ExecutorService executor = Executors.newSingleThreadExecutor();
spark = Service.ignite();
spark.port(port);
spark.get(\"/\", (req, res) -> executor.submit(() -> this.getHello(req, res)).get());
spark.post(\"/apply\", (req, res) -> executor.submit(() -> this.postApply(req, res)).get());
executor.submit(this::subscribeAndLoadOldEvents);
Logger.getGlobal().info(\"Shop service is up and running on port \" + port);
"
  modified: 	false
  modifiers: 	public
  name: 	start
  paramsString: 	""
  returnType: 	void
  signature: 	"class/ShopService/method/start()"

- shopService_getHello: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private String getHello(Request req, Response res)"
  id: 	ShopService_getHello
  methodBody: 	"try {
   String events = Yaml.encode(getHistory().values().toArray());
   String objects = Yaml.encode(model.getModelMap().values().toArray());
   return \"<p id='Shop'>This is the Shop service. </p>\n\" +
         \"<pre id=\\"history\\">\" + events + \"</pre>\n\" +
         \"<pre id=\\"data\\">\" + objects + \"</pre>\n\" +
         \"\";
}
catch (Exception e) {
   Logger.getGlobal().log(Level.SEVERE, e.getMessage(), e);
   return \"Shop Error \" + e.getMessage();
}
"
  modified: 	false
  modifiers: 	private
  name: 	getHello
  paramsString: 	"Request req, Response res"
  returnType: 	String
  signature: 	"class/ShopService/method/getHello(Request,Response)"

- shopService_subscribeAndLoadOldEvents: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void subscribeAndLoadOldEvents()"
  id: 	ShopService_subscribeAndLoadOldEvents
  methodBody: 	"ServiceSubscribed serviceSubscribed = new ServiceSubscribed()
      .setServiceUrl(\"http://localhost:42100/apply\");
String json = Yaml.encode(serviceSubscribed);
try {
   String url = \"http://localhost:42000/subscribe\";
   HttpResponse<String> response = Unirest
         .post(url)
         .body(json)
         .asString();
   String body = response.getBody();
   Map<String, Object> objectMap = Yaml.decode(body);
   for (Object obj : objectMap.values()) {
      apply((Event) obj);
   }
}
catch (UnirestException e) {
   e.printStackTrace();
}"
  modified: 	false
  modifiers: 	private
  name: 	subscribeAndLoadOldEvents
  paramsString: 	""
  returnType: 	void
  signature: 	"class/ShopService/method/subscribeAndLoadOldEvents()"

- shopService_apply: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"public void apply(Event event)"
  id: 	ShopService_apply
  methodBody: 	"if (history.get(event.getId()) != null) {
   return;
}
initEventHandlerMap();
Consumer<Event> handler = handlerMap.computeIfAbsent(event.getClass(), k -> this::ignoreEvent);
handler.accept(event);
history.put(event.getId(), event);
publish(event);"
  modified: 	false
  modifiers: 	public
  name: 	apply
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/ShopService/method/apply(Event)"

- shopService_handleOrderRegistered: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void handleOrderRegistered(Event e)"
  id: 	ShopService_handleOrderRegistered
  methodBody: 	"OrderRegistered event = (OrderRegistered) e;
if (event.getId().equals(\"13:01\")) {

   Order order1300 = model.getOrCreateOrder(\"order1300\");
   order1300.setProduct(\"shoes\");
   order1300.setCustomer(\"Alice\");
   order1300.setAddress(\"Wonderland 1\");
   order1300.setState(\"pending\");

   Customer alice = model.getOrCreateCustomer(\"Alice\");
   alice.setOrders(\"[order1300]\");
}
if (event.getId().equals(\"13:11\")) {

   Order order1310 = model.getOrCreateOrder(\"order1310\");
   order1310.setProduct(\"tshirt\");
   order1310.setCustomer(\"Alice\");
   order1310.setAddress(\"Wonderland 1\");
   order1310.setState(\"pending\");

   Customer alice = model.getOrCreateCustomer(\"Alice\");
   alice.setOrders(\"[order1300 order1310]\");
}
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderRegistered
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/ShopService/method/handleOrderRegistered(Event)"

- shopService_handleOrderApproved: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void handleOrderApproved(Event e)"
  id: 	ShopService_handleOrderApproved
  methodBody: 	"OrderApproved event = (OrderApproved) e;
if (event.getId().equals(\"13:05\")) {

   Order order1300 = model.getOrCreateOrder(\"order1300\");
   order1300.setState(\"picking\");
}
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderApproved
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/ShopService/method/handleOrderApproved(Event)"

- shopService_handleOrderPicked: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void handleOrderPicked(Event e)"
  id: 	ShopService_handleOrderPicked
  methodBody: 	"OrderPicked event = (OrderPicked) e;
if (event.getId().equals(\"14:00\")) {

   Order order1300 = model.getOrCreateOrder(\"order1300\");
   order1300.setState(\"shipping\");
}
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderPicked
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/ShopService/method/handleOrderPicked(Event)"

- shopService_handleOrderDeclined: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void handleOrderDeclined(Event e)"
  id: 	ShopService_handleOrderDeclined
  methodBody: 	"OrderDeclined event = (OrderDeclined) e;
if (event.getId().equals(\"13:14\")) {

   Order order1310 = model.getOrCreateOrder(\"order1310\");
   order1310.setState(\"out of stock\");
}
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderDeclined
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/ShopService/method/handleOrderDeclined(Event)"

- shopService_initEventHandlerMap: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void initEventHandlerMap()"
  id: 	ShopService_initEventHandlerMap
  methodBody: 	"if (handlerMap == null) {
   handlerMap = new LinkedHashMap<>();
   handlerMap.put(OrderRegistered.class, this::handleOrderRegistered);
   handlerMap.put(OrderApproved.class, this::handleOrderApproved);
   handlerMap.put(OrderPicked.class, this::handleOrderPicked);
   handlerMap.put(OrderDeclined.class, this::handleOrderDeclined);
}
"
  modified: 	false
  modifiers: 	private
  name: 	initEventHandlerMap
  paramsString: 	""
  returnType: 	void
  signature: 	"class/ShopService/method/initEventHandlerMap()"

- shopService_ignoreEvent: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private void ignoreEvent(Event event)"
  id: 	ShopService_ignoreEvent
  methodBody: 	"// empty
"
  modified: 	false
  modifiers: 	private
  name: 	ignoreEvent
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/ShopService/method/ignoreEvent(Event)"

- shopService_publish: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"public void publish(Event event)"
  id: 	ShopService_publish
  methodBody: 	"String json = Yaml.encode(event);

try {
   HttpResponse<String> response = Unirest
         .post(\"http://localhost:42000/publish\")
         .body(json)
         .asString();
}
catch (UnirestException e) {
   e.printStackTrace();
}"
  modified: 	false
  modifiers: 	public
  name: 	publish
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/ShopService/method/publish(Event)"

- shopService_postApply: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	shopService
  declaration: 	"private String postApply(Request req, Response res)"
  id: 	ShopService_postApply
  methodBody: 	"      try {
         String body = req.body();
         Map<String, Object> map = Yaml.decode(body);
         for (Object value : map.values()) {
            Event event = (Event) value;
            apply(event);
         }
      }
      catch (Exception e) {
         Logger.getGlobal().log(Level.SEVERE, \"postApply failed\", e);
      }
      return \"apply done\";"
  modified: 	false
  modifiers: 	private
  name: 	postApply
  paramsString: 	"Request req, Response res"
  returnType: 	String
  signature: 	"class/ShopService/method/postApply(Request,Response)"

- order_id: 	org.fulib.classmodel.Attribute
  clazz: 	order
  id: 	Order_id
  modified: 	false
  name: 	id
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- order_product: 	org.fulib.classmodel.Attribute
  clazz: 	order
  id: 	Order_product
  modified: 	false
  name: 	product
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- order_customer: 	org.fulib.classmodel.Attribute
  clazz: 	order
  id: 	Order_customer
  modified: 	false
  name: 	customer
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- order_address: 	org.fulib.classmodel.Attribute
  clazz: 	order
  id: 	Order_address
  modified: 	false
  name: 	address
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- order_state: 	org.fulib.classmodel.Attribute
  clazz: 	order
  id: 	Order_state
  modified: 	false
  name: 	state
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- customer_id: 	org.fulib.classmodel.Attribute
  clazz: 	customer
  id: 	Customer_id
  modified: 	false
  name: 	id
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- customer_orders: 	org.fulib.classmodel.Attribute
  clazz: 	customer
  id: 	Customer_orders
  modified: 	false
  name: 	orders
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

