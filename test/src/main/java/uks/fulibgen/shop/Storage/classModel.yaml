- c: 	org.fulib.classmodel.ClassModel
  classes: 	storageModel 	storageService 	box 	pickTask
  defaultCollectionType: 	c1
  defaultPropertyStyle: 	Bean
  defaultRoleType: 	"java.util.ArrayList<%s>"
  mainJavaDir: 	"src/main/java"
  packageName: 	uks.fulibgen.shop.Storage
  packageSrcFolder: 	"src/main/java/uks/fulibgen/shop/Storage"

- storageModel: 	org.fulib.classmodel.Clazz
  attributes: 	storageModel_modelMap
  importList: 	"import java.util.LinkedHashMap;"
  imports: 	"import java.util.LinkedHashMap;"
  methods: 	storageModel_getOrCreateBox 	storageModel_getOrCreatePickTask
  model: 	c
  modified: 	false
  name: 	StorageModel
  propertyStyle: 	Bean

- storageService: 	org.fulib.classmodel.Clazz
  attributes: 	storageService_history 	storageService_port 	storageService_spark 	storageService_model 	storageService_handlerMap
  importList: 	"import java.util.LinkedHashMap;" 	"import java.util.Map;" 	"import java.util.function.Consumer;" 	"import uks.fulibgen.shop.events.*;" 	"import org.fulib.yaml.Yaml;" 	"import spark.Service;" 	"import spark.Request;" 	"import spark.Response;" 	"import com.mashape.unirest.http.HttpResponse;" 	"import com.mashape.unirest.http.Unirest;" 	"import com.mashape.unirest.http.exceptions.UnirestException;" 	"import java.util.concurrent.ExecutorService;" 	"import java.util.concurrent.Executors;" 	"import java.util.logging.Logger;" 	"import java.util.logging.Level;"
  imports: 	"import java.util.LinkedHashMap;" 	"import java.util.Map;" 	"import java.util.function.Consumer;" 	"import uks.fulibgen.shop.events.*;" 	"import org.fulib.yaml.Yaml;" 	"import spark.Service;" 	"import spark.Request;" 	"import spark.Response;" 	"import com.mashape.unirest.http.HttpResponse;" 	"import com.mashape.unirest.http.Unirest;" 	"import com.mashape.unirest.http.exceptions.UnirestException;" 	"import java.util.concurrent.ExecutorService;" 	"import java.util.concurrent.Executors;" 	"import java.util.logging.Logger;" 	"import java.util.logging.Level;"
  methods: 	storageService_start 	storageService_getHello 	storageService_subscribeAndLoadOldEvents 	storageService_apply 	storageService_getPage 	storageService_getDemoPage 	storageService_handleProductStored 	storageService_handleDemoProductStored 	storageService_handleOrderRegistered 	storageService_handleDemoOrderRegistered 	storageService_handleOrderPicked 	storageService_handleDemoOrderPicked 	storageService_handleBoxBuilt 	storageService_handlePickTaskBuilt 	storageService_initEventHandlerMap 	storageService_ignoreEvent 	storageService_publish 	storageService_postApply 	storageService_stripBrackets
  model: 	c
  modified: 	false
  name: 	StorageService
  propertyStyle: 	Bean

- box: 	org.fulib.classmodel.Clazz
  attributes: 	box_id 	box_product 	box_place
  model: 	c
  modified: 	false
  name: 	Box
  propertyStyle: 	Bean

- pickTask: 	org.fulib.classmodel.Clazz
  attributes: 	pickTask_id 	pickTask_order 	pickTask_product 	pickTask_customer 	pickTask_address 	pickTask_state 	pickTask_box
  model: 	c
  modified: 	false
  name: 	PickTask
  propertyStyle: 	Bean

- c1: 	org.fulib.classmodel.CollectionType
  implClass: 	class java.util.ArrayList
  implTemplate: 	"java.util.ArrayList<%s>"
  itf: 	org.fulib.classmodel.CollectionInterface.List
  qualifiedImplName: 	java.util.ArrayList
  simpleImplName: 	ArrayList

- storageModel_modelMap: 	org.fulib.classmodel.Attribute
  clazz: 	storageModel
  id: 	StorageModel_modelMap
  initialization: 	"new LinkedHashMap<>()"
  modified: 	false
  name: 	modelMap
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<String, Object>"
  typeSignature: 	"LinkedHashMap<String,Object>"

- storageModel_getOrCreateBox: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageModel
  declaration: 	"public Box getOrCreateBox(String id)"
  id: 	StorageModel_getOrCreateBox
  methodBody: 	"if (id == null) return null;
return (Box) modelMap.computeIfAbsent(id, k -> new Box().setId(k));
"
  modified: 	false
  modifiers: 	public
  name: 	getOrCreateBox
  paramsString: 	"String id"
  returnType: 	Box
  signature: 	"class/StorageModel/method/getOrCreateBox(String)"

- storageModel_getOrCreatePickTask: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageModel
  declaration: 	"public PickTask getOrCreatePickTask(String id)"
  id: 	StorageModel_getOrCreatePickTask
  methodBody: 	"if (id == null) return null;
return (PickTask) modelMap.computeIfAbsent(id, k -> new PickTask().setId(k));
"
  modified: 	false
  modifiers: 	public
  name: 	getOrCreatePickTask
  paramsString: 	"String id"
  returnType: 	PickTask
  signature: 	"class/StorageModel/method/getOrCreatePickTask(String)"

- storageService_history: 	org.fulib.classmodel.Attribute
  clazz: 	storageService
  id: 	StorageService_history
  initialization: 	"new LinkedHashMap<>()"
  modified: 	false
  name: 	history
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<String, Event>"
  typeSignature: 	"LinkedHashMap<String,Event>"

- storageService_port: 	org.fulib.classmodel.Attribute
  clazz: 	storageService
  id: 	StorageService_port
  initialization: 	42003
  modified: 	false
  name: 	port
  propertyStyle: 	Bean
  type: 	int
  typeSignature: 	int

- storageService_spark: 	org.fulib.classmodel.Attribute
  clazz: 	storageService
  id: 	StorageService_spark
  modified: 	false
  name: 	spark
  propertyStyle: 	Bean
  type: 	Service
  typeSignature: 	Service

- storageService_model: 	org.fulib.classmodel.Attribute
  clazz: 	storageService
  id: 	StorageService_model
  modified: 	false
  name: 	model
  propertyStyle: 	Bean
  type: 	StorageModel
  typeSignature: 	StorageModel

- storageService_handlerMap: 	org.fulib.classmodel.Attribute
  clazz: 	storageService
  id: 	StorageService_handlerMap
  modified: 	false
  name: 	handlerMap
  propertyStyle: 	Bean
  type: 	"LinkedHashMap<Class, Consumer<Event>>"
  typeSignature: 	"LinkedHashMap<Class,Consumer<Event>>"

- storageService_start: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public void start()"
  id: 	StorageService_start
  methodBody: 	"model = new StorageModel();
ExecutorService executor = Executors.newSingleThreadExecutor();
spark = Service.ignite();
spark.port(port);
spark.get(\"/page/:id\", (req, res) -> executor.submit(() -> this.getPage(req, res)).get());
spark.get(\"/\", (req, res) -> executor.submit(() -> this.getHello(req, res)).get());
spark.post(\"/apply\", (req, res) -> executor.submit(() -> this.postApply(req, res)).get());
executor.submit(this::subscribeAndLoadOldEvents);
Logger.getGlobal().info(\"Storage service is up and running on port \" + port);
"
  modified: 	false
  modifiers: 	public
  name: 	start
  paramsString: 	""
  returnType: 	void
  signature: 	"class/StorageService/method/start()"

- storageService_getHello: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private String getHello(Request req, Response res)"
  id: 	StorageService_getHello
  methodBody: 	"try {
   String events = Yaml.encode(getHistory().values().toArray());
   String objects = Yaml.encode(model.getModelMap().values().toArray());
   return \"<p id='Storage'>This is the Storage service. </p>\n\" +
         \"<pre id=\\"history\\">\" + events + \"</pre>\n\" +
         \"<pre id=\\"data\\">\" + objects + \"</pre>\n\" +
         \"\";
}
catch (Exception e) {
   Logger.getGlobal().log(Level.SEVERE, e.getMessage(), e);
   return \"Storage Error \" + e.getMessage();
}
"
  modified: 	false
  modifiers: 	private
  name: 	getHello
  paramsString: 	"Request req, Response res"
  returnType: 	String
  signature: 	"class/StorageService/method/getHello(Request,Response)"

- storageService_subscribeAndLoadOldEvents: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void subscribeAndLoadOldEvents()"
  id: 	StorageService_subscribeAndLoadOldEvents
  methodBody: 	"ServiceSubscribed serviceSubscribed = new ServiceSubscribed()
      .setServiceUrl(\"http://localhost:42003/apply\");
String json = Yaml.encode(serviceSubscribed);
try {
   String url = \"http://localhost:42000/subscribe\";
   HttpResponse<String> response = Unirest
         .post(url)
         .body(json)
         .asString();
   String body = response.getBody();
   Map<String, Object> objectMap = Yaml.decode(body);
   for (Object obj : objectMap.values()) {
      apply((Event) obj);
   }
}
catch (UnirestException e) {
   e.printStackTrace();
}"
  modified: 	false
  modifiers: 	private
  name: 	subscribeAndLoadOldEvents
  paramsString: 	""
  returnType: 	void
  signature: 	"class/StorageService/method/subscribeAndLoadOldEvents()"

- storageService_apply: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public void apply(Event event)"
  id: 	StorageService_apply
  methodBody: 	"if (history.get(event.getId()) != null) {
   return;
}
initEventHandlerMap();
Consumer<Event> handler = handlerMap.computeIfAbsent(event.getClass(), k -> this::ignoreEvent);
handler.accept(event);
history.put(event.getId(), event);
publish(event);"
  modified: 	false
  modifiers: 	public
  name: 	apply
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/StorageService/method/apply(Event)"

- storageService_getPage: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public String getPage(Request request, Response response)"
  id: 	StorageService_getPage
  methodBody: 	"// no fulib
// add your page handling here
return getDemoPage(request, response);
"
  modified: 	false
  modifiers: 	public
  name: 	getPage
  paramsString: 	"Request request, Response response"
  returnType: 	String
  signature: 	"class/StorageService/method/getPage(Request,Response)"

- storageService_getDemoPage: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public String getDemoPage(Request request, Response response)"
  id: 	StorageService_getDemoPage
  methodBody: 	"StringBuilder html = new StringBuilder();
String id = request.params(\"id\");
String event = request.queryParams(\"event\");



html.append(\"This is the Shop Service page \" + id + \"\n\");
return html.toString();"
  modified: 	false
  modifiers: 	public
  name: 	getDemoPage
  paramsString: 	"Request request, Response response"
  returnType: 	String
  signature: 	"class/StorageService/method/getDemoPage(Request,Response)"

- storageService_handleProductStored: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleProductStored(Event e)"
  id: 	StorageService_handleProductStored
  methodBody: 	"// no fulib
ProductStored event = (ProductStored) e;
handleDemoProductStored(event);
"
  modified: 	false
  modifiers: 	private
  name: 	handleProductStored
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/StorageService/method/handleProductStored(Event)"

- storageService_handleDemoProductStored: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleDemoProductStored(ProductStored event)"
  id: 	StorageService_handleDemoProductStored
  methodBody: 	"if (event.getId().equals(\"12:00\")) {
   BoxBuilt box23Event = new BoxBuilt();
   box23Event.setId(\"12:02\");
   box23Event.setBlockId(\"box23\");
   box23Event.setProduct(\"shoes\");
   box23Event.setPlace(\"shelf23\");
   apply(box23Event);

}
"
  modified: 	false
  modifiers: 	private
  name: 	handleDemoProductStored
  paramsString: 	"ProductStored event"
  returnType: 	void
  signature: 	"class/StorageService/method/handleDemoProductStored(ProductStored)"

- storageService_handleOrderRegistered: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleOrderRegistered(Event e)"
  id: 	StorageService_handleOrderRegistered
  methodBody: 	"// no fulib
OrderRegistered event = (OrderRegistered) e;
handleDemoOrderRegistered(event);
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderRegistered
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/StorageService/method/handleOrderRegistered(Event)"

- storageService_handleDemoOrderRegistered: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleDemoOrderRegistered(OrderRegistered event)"
  id: 	StorageService_handleDemoOrderRegistered
  methodBody: 	"if (event.getId().equals(\"13:01\")) {
   PickTaskBuilt pick1300Event = new PickTaskBuilt();
   pick1300Event.setId(\"13:04\");
   pick1300Event.setBlockId(\"pick1300\");
   pick1300Event.setOrder(\"order1300\");
   pick1300Event.setProduct(\"shoes\");
   pick1300Event.setCustomer(\"Alice\");
   pick1300Event.setAddress(\"Wonderland 1\");
   pick1300Event.setState(\"todo\");
   apply(pick1300Event);


   OrderApproved e1305 = new OrderApproved();

   e1305.setId(\"13:05\");
   e1305.setEvent(\"order approved 13:05\");
   e1305.setOrder(\"order1300\");
   apply(e1305);
}
if (event.getId().equals(\"13:11\")) {

   OrderDeclined e1314 = new OrderDeclined();

   e1314.setId(\"13:14\");
   e1314.setEvent(\"order declined 13:14\");
   e1314.setOrder(\"order1310\");
   apply(e1314);
}
"
  modified: 	false
  modifiers: 	private
  name: 	handleDemoOrderRegistered
  paramsString: 	"OrderRegistered event"
  returnType: 	void
  signature: 	"class/StorageService/method/handleDemoOrderRegistered(OrderRegistered)"

- storageService_handleOrderPicked: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleOrderPicked(Event e)"
  id: 	StorageService_handleOrderPicked
  methodBody: 	"// no fulib
OrderPicked event = (OrderPicked) e;
handleDemoOrderPicked(event);
"
  modified: 	false
  modifiers: 	private
  name: 	handleOrderPicked
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/StorageService/method/handleOrderPicked(Event)"

- storageService_handleDemoOrderPicked: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleDemoOrderPicked(OrderPicked event)"
  id: 	StorageService_handleDemoOrderPicked
  methodBody: 	"if (event.getId().equals(\"14:00\")) {
   PickTaskBuilt pick1300Event = new PickTaskBuilt();
   pick1300Event.setId(\"14:01\");
   pick1300Event.setBlockId(\"pick1300\");
   pick1300Event.setState(\"done\");
   pick1300Event.setBox(\"box23\");
   apply(pick1300Event);

   BoxBuilt box23Event = new BoxBuilt();
   box23Event.setId(\"14:02\");
   box23Event.setBlockId(\"box23\");
   box23Event.setPlace(\"shipping\");
   apply(box23Event);

}
"
  modified: 	false
  modifiers: 	private
  name: 	handleDemoOrderPicked
  paramsString: 	"OrderPicked event"
  returnType: 	void
  signature: 	"class/StorageService/method/handleDemoOrderPicked(OrderPicked)"

- storageService_handleBoxBuilt: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handleBoxBuilt(Event e)"
  id: 	StorageService_handleBoxBuilt
  methodBody: 	"BoxBuilt event = (BoxBuilt) e;
Box object = model.getOrCreateBox(event.getBlockId());
object.setProduct(event.getProduct());
object.setPlace(event.getPlace());
"
  modified: 	false
  modifiers: 	private
  name: 	handleBoxBuilt
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/StorageService/method/handleBoxBuilt(Event)"

- storageService_handlePickTaskBuilt: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void handlePickTaskBuilt(Event e)"
  id: 	StorageService_handlePickTaskBuilt
  methodBody: 	"PickTaskBuilt event = (PickTaskBuilt) e;
PickTask object = model.getOrCreatePickTask(event.getBlockId());
object.setOrder(event.getOrder());
object.setProduct(event.getProduct());
object.setCustomer(event.getCustomer());
object.setAddress(event.getAddress());
object.setState(event.getState());
object.setBox(event.getBox());
"
  modified: 	false
  modifiers: 	private
  name: 	handlePickTaskBuilt
  paramsString: 	"Event e"
  returnType: 	void
  signature: 	"class/StorageService/method/handlePickTaskBuilt(Event)"

- storageService_initEventHandlerMap: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void initEventHandlerMap()"
  id: 	StorageService_initEventHandlerMap
  methodBody: 	"if (handlerMap == null) {
   handlerMap = new LinkedHashMap<>();
   handlerMap.put(ProductStored.class, this::handleProductStored);
   handlerMap.put(OrderRegistered.class, this::handleOrderRegistered);
   handlerMap.put(OrderPicked.class, this::handleOrderPicked);
   handlerMap.put(BoxBuilt.class, this::handleBoxBuilt);
   handlerMap.put(PickTaskBuilt.class, this::handlePickTaskBuilt);
}
"
  modified: 	false
  modifiers: 	private
  name: 	initEventHandlerMap
  paramsString: 	""
  returnType: 	void
  signature: 	"class/StorageService/method/initEventHandlerMap()"

- storageService_ignoreEvent: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private void ignoreEvent(Event event)"
  id: 	StorageService_ignoreEvent
  methodBody: 	"// empty
"
  modified: 	false
  modifiers: 	private
  name: 	ignoreEvent
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/StorageService/method/ignoreEvent(Event)"

- storageService_publish: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public void publish(Event event)"
  id: 	StorageService_publish
  methodBody: 	"String json = Yaml.encode(event);

try {
   HttpResponse<String> response = Unirest
         .post(\"http://localhost:42000/publish\")
         .body(json)
         .asString();
}
catch (UnirestException e) {
   e.printStackTrace();
}"
  modified: 	false
  modifiers: 	public
  name: 	publish
  paramsString: 	"Event event"
  returnType: 	void
  signature: 	"class/StorageService/method/publish(Event)"

- storageService_postApply: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"private String postApply(Request req, Response res)"
  id: 	StorageService_postApply
  methodBody: 	"      try {
         String body = req.body();
         Map<String, Object> map = Yaml.decode(body);
         for (Object value : map.values()) {
            Event event = (Event) value;
            apply(event);
         }
      }
      catch (Exception e) {
         Logger.getGlobal().log(Level.SEVERE, \"postApply failed\", e);
      }
      return \"apply done\";"
  modified: 	false
  modifiers: 	private
  name: 	postApply
  paramsString: 	"Request req, Response res"
  returnType: 	String
  signature: 	"class/StorageService/method/postApply(Request,Response)"

- storageService_stripBrackets: 	org.fulib.classmodel.FMethod
  annotations: 	""
  clazz: 	storageService
  declaration: 	"public String stripBrackets(String back)"
  id: 	StorageService_stripBrackets
  methodBody: 	"      if (back == null) {
         return \"\";
      }
      int open = back.indexOf('[');
      int close = back.indexOf(']');
      if (open >= 0 && close >= 0) {
         back = back.substring(open + 1, close);
      }
      return back;"
  modified: 	false
  modifiers: 	public
  name: 	stripBrackets
  paramsString: 	"String back"
  returnType: 	String
  signature: 	"class/StorageService/method/stripBrackets(String)"

- box_id: 	org.fulib.classmodel.Attribute
  clazz: 	box
  id: 	Box_id
  modified: 	false
  name: 	id
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- box_product: 	org.fulib.classmodel.Attribute
  clazz: 	box
  id: 	Box_product
  modified: 	false
  name: 	product
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- box_place: 	org.fulib.classmodel.Attribute
  clazz: 	box
  id: 	Box_place
  modified: 	false
  name: 	place
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_id: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_id
  modified: 	false
  name: 	id
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_order: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_order
  modified: 	false
  name: 	order
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_product: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_product
  modified: 	false
  name: 	product
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_customer: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_customer
  modified: 	false
  name: 	customer
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_address: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_address
  modified: 	false
  name: 	address
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_state: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_state
  modified: 	false
  name: 	state
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

- pickTask_box: 	org.fulib.classmodel.Attribute
  clazz: 	pickTask
  id: 	PickTask_box
  modified: 	false
  name: 	box
  propertyStyle: 	Bean
  type: 	String
  typeSignature: 	String

